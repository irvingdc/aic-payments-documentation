<html><head><meta charSet="utf-8"/><title data-react-helmet="true">Android · AppInChinaPay</title><meta data-react-helmet="true" name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/><link rel="stylesheet" href="asset/plugins/theme-default/reader/style.css"/><style data-react-helmet="true" type="text/css">.ಠhighlight-container code[class*=language-],.ಠhighlight-container pre[class*=language-]{color:#000;background:none;text-shadow:0 1px #fff;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}.ಠhighlight-container code[class*=language-]::-moz-selection,.ಠhighlight-container code[class*=language-] ::-moz-selection,.ಠhighlight-container pre[class*=language-]::-moz-selection,.ಠhighlight-container pre[class*=language-] ::-moz-selection{text-shadow:none;background:#b3d4fc}.ಠhighlight-container code[class*=language-]::selection,.ಠhighlight-container code[class*=language-] ::selection,.ಠhighlight-container pre[class*=language-]::selection,.ಠhighlight-container pre[class*=language-] ::selection{text-shadow:none;background:#b3d4fc}@media print{.ಠhighlight-container code[class*=language-],.ಠhighlight-container pre[class*=language-]{text-shadow:none}}.ಠhighlight-container pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}.ಠhighlight-container :not(pre)>code[class*=language-],.ಠhighlight-container pre[class*=language-]{background:#f5f2f0}.ಠhighlight-container :not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.ಠhighlight-container .token.cdata,.ಠhighlight-container .token.comment,.ಠhighlight-container .token.doctype,.ಠhighlight-container .token.prolog{color:#708090}.ಠhighlight-container .token.punctuation{color:#999}.ಠhighlight-container .namespace{opacity:.7}.ಠhighlight-container .token.boolean,.ಠhighlight-container .token.constant,.ಠhighlight-container .token.deleted,.ಠhighlight-container .token.number,.ಠhighlight-container .token.property,.ಠhighlight-container .token.symbol,.ಠhighlight-container .token.tag{color:#905}.ಠhighlight-container .token.attr-name,.ಠhighlight-container .token.builtin,.ಠhighlight-container .token.char,.ಠhighlight-container .token.inserted,.ಠhighlight-container .token.selector,.ಠhighlight-container .token.string{color:#690}.ಠhighlight-container .language-css .token.string,.ಠhighlight-container .style .token.string,.ಠhighlight-container .token.entity,.ಠhighlight-container .token.operator,.ಠhighlight-container .token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.ಠhighlight-container .token.atrule,.ಠhighlight-container .token.attr-value,.ಠhighlight-container .token.keyword{color:#07a}.ಠhighlight-container .token.class-name,.ಠhighlight-container .token.function{color:#dd4a68}.ಠhighlight-container .token.important,.ಠhighlight-container .token.regex,.ಠhighlight-container .token.variable{color:#e90}.ಠhighlight-container .token.bold,.ಠhighlight-container .token.important{font-weight:700}.ಠhighlight-container .token.italic{font-style:italic}.ಠhighlight-container .token.entity{cursor:help}</style><style>
.ಠapi-actions{
    margin-left: 20px;
}
.ಠapi-url{
margin-left:15px;
}
.ui.icon.ಠapi-compass{
    display: none;
}
</style></head><body><div id="main"><div class="window-container"><img src="cover.jpg" style="position:absolute;visibility:hidden"/><div><div class="Loading__loading___1m_fZ"><div class="Loading__bar___21yOt" style="background:#21ba45;width:0%;display:none"><div class="Loading__peg___3Y_28"></div></div></div><div class="Loading__spinner___11Pm4"><div class="Loading__icon___3OOyu" style="display:none;border-color:#21ba45"></div></div></div><div class="window-body"><div class="sidebar"><div class="sidebar-header"><a href="." class="title">AppInChinaPay</a><div class="search-form"><div class="ui small fluid icon input"><input type="text" placeholder="Search..."/><i class="icon search"></i></div></div></div><div class="sidebar-body"><div class="catalog-body"><ul><li class="open"><div class="wholerow"></div><i class="icon"></i><a href="Introduction.html" class="text">Introduction</a></li><li class="open"><div class="wholerow"></div><i class="icon"></i><a href="AppConfiguration.html" class="text">App Configuration</a></li><li class="open"><div class="wholerow"></div><i class="icon caret down"></i><a href="SDKInstallation.html" class="text">SDK Installation</a><ul><li class=""><div class="wholerow"></div><i class="icon"></i><a href="AndroidSdk.html" class="text">Android SDK</a></li><li class=""><div class="wholerow"></div><i class="icon"></i><a href="iOSSdk.html" class="text">iOS SDK</a></li></ul></li><li class="open"><div class="wholerow"></div><i class="icon caret down"></i><a href="API.html" class="text">API</a><ul><li class=""><div class="wholerow"></div><i class="icon"></i><a href="APIAuthentication.html" class="text">API Authentication</a></li><li class=""><div class="wholerow"></div><i class="icon"></i><a href="PayToolsInit.html" class="text">Pay Channel Init</a></li><li class=""><div class="wholerow"></div><i class="icon"></i><a href="Order.html" class="text">Create Order</a></li><li class=""><div class="wholerow"></div><i class="icon"></i><a href="QueryOrder.html" class="text">Query Order</a></li><li class=""><div class="wholerow"></div><i class="icon"></i><a href="QueryOrderList.html" class="text">Query Order List</a></li></ul></li><li class="open"><div class="wholerow"></div><i class="icon caret down"></i><a href="InitiatePayment.html" class="text">Initiate Payment</a><ul><li class=""><div class="wholerow"></div><i class="icon"></i><a href="HowtoFireaPay.html" class="text">How to Fire a Pay</a></li><li class=""><div class="wholerow"></div><i class="icon"></i><a href="Android.html" class="text">Android</a></li><li class=""><div class="wholerow"></div><i class="icon"></i><a href="iOS.html" class="text">iOS</a></li></ul></li><li class="open"><div class="wholerow"></div><i class="icon caret down"></i><a href="PurchaseRestore.html" class="text">Purchase Restore</a><ul><li class=""><div class="wholerow"></div><i class="icon"></i><a href="BasicPrinciples.html" class="text">Basic Principles</a></li><li class=""><div class="wholerow"></div><i class="icon"></i><a href="Authentication.html" class="text">Authentication</a></li><li class=""><div class="wholerow"></div><i class="icon"></i><a href="SmsCode.html" class="text">Sms Code</a></li><li class=""><div class="wholerow"></div><i class="icon"></i><a href="LogonStatusCheck.html" class="text">Logon Status Check</a></li><li class=""><div class="wholerow"></div><i class="icon"></i><a href="TypicalScenarios.html" class="text">Typical Scenarios</a></li></ul></li><li class="open"><div class="wholerow"></div><i class="icon caret down"></i><a href="Help.html" class="text">Help</a><ul><li class=""><div class="wholerow"></div><i class="icon"></i><a href="Video.html" class="text">Video</a></li><li class=""><div class="wholerow"></div><i class="icon"></i><a href="faq.html" class="text">Frequently Asked Questions</a></li><li class=""><div class="wholerow"></div><i class="icon"></i><a href="UpdateNotes.html" class="text">Update Notes</a></li></ul></li></ul></div></div><div class="sidebar-copyright">本文档使用 <a href="https://www.kancloud.cn" target="_blank">看云</a> 构建</div></div><div class="workspace"><div class="article"><div class="article-head"><div class="left tools"><a class="item icon"><i class="icon align justify"></i></a></div><h1>Android</h1><div class="right tools"><div role="listbox" aria-expanded="false" class="ui top right pointing dropdown item" tabindex="0"><div class="text" role="alert" aria-live="polite"></div><i aria-hidden="true" class="share alternate icon"></i><div class="menu transition"><div role="option" class="item"><i aria-hidden="true" class="linkify icon"></i><span class="text">复制链接</span></div><div role="option" class="item"><i aria-hidden="true" class="qq icon"></i><span class="text">腾讯QQ</span></div><div role="option" class="item"><i aria-hidden="true" class="weibo icon"></i><span class="text">新浪微博</span></div><div class="header"><p><i class="icon wechat"></i><span class="text">微信扫一扫</span></p><img src="https://bshare.optimix.asia/barCode?site=weixin&amp;url=file%3A%2F%2F.%2Fcontent%2FAndroid.md"/></div></div></div></div></div><div class="article-body kancloud-markdown-body"><h1><a id="1_Android_for_wechat_0"></a>1. Android for wechat</h1>
<h3><a id="11_Android_Java_2"></a>1.1 Android Java:</h3>
<pre><code class="ಠhighlight-container">JSONObject data <span class="token operator">=</span> <span class="token punctuation">(</span>JSONObject<span class="token punctuation">)</span> bundle<span class="token punctuation">.</span><span class="token function">getSerializable</span><span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// {appid=wx7f229e38a04f2bec, noncestr=LXyHXBUVh39LYBrK, package=Sign=WXPay, partnerid=1523808161, prepayid=wx2613502950188989bf5937ec1163319167, sign=50F044924686609080E94B7C6EB7969E, timestamp=1551160229}</span>
PayReq req <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PayReq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
req<span class="token punctuation">.</span>appId <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"appid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
req<span class="token punctuation">.</span>partnerId <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"partnerid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
req<span class="token punctuation">.</span>prepayId <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"prepayid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
req<span class="token punctuation">.</span>nonceStr <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"noncestr"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
req<span class="token punctuation">.</span>timeStamp <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"timestamp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
req<span class="token punctuation">.</span>packageValue <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"package"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
req<span class="token punctuation">.</span>sign <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"sign"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
​
Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> req<span class="token punctuation">.</span><span class="token function">checkArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" param check result"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
boolean v <span class="token operator">=</span> api<span class="token punctuation">.</span><span class="token function">sendReq</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> v <span class="token operator">+</span> <span class="token string">" startup pay result"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<hr/>
<h1><a id="2Android_for_Alipay_24"></a>2.Android for Alipay</h1>
<h3><a id="21_Init_Alipay_parameter_26"></a>2.1 Init Alipay parameter</h3>
<pre><code class="ಠhighlight-container"><span class="token comment">// app id</span>
private final String APP_ID <span class="token operator">=</span> <span class="token string">"20190307001"</span><span class="token punctuation">;</span>
       
</code></pre>
<h3><a id="22_Init_the_Api_parameter_33"></a>2.2 Init the Api parameter</h3>
<pre><code class="ಠhighlight-container">
<span class="token comment">// pay channel API</span>
private final  String  BASE_URL <span class="token operator">=</span>  <span class="token string">"http://cashier.51mandou.com"</span><span class="token punctuation">;</span>
private final String GET_PAY_TOOLS <span class="token operator">=</span> BASE_URL <span class="token operator">+</span> <span class="token string">"/payTools.json"</span> <span class="token punctuation">;</span>

<span class="token comment">// createOrder API</span>
public  final  String  CREATE_ORDER  <span class="token operator">=</span>  BASE_URL<span class="token operator">+</span><span class="token string">"/order.json"</span><span class="token punctuation">;</span>

 <span class="token comment">// order amount </span>
String amountStr <span class="token operator">=</span> <span class="token string">"99"</span><span class="token punctuation">;</span>

<span class="token comment">// your business No.</span>
String bizNoStr <span class="token operator">=</span> <span class="token string">"biz No"</span> <span class="token punctuation">;</span>

<span class="token comment">// your goods title</span>
String titleStr <span class="token operator">=</span> <span class="token string">" test goods title"</span><span class="token punctuation">;</span>

<span class="token comment">// your app_id and secret</span>
private final String APP_SECRET <span class="token operator">=</span> <span class="token string">"123"</span><span class="token punctuation">;</span>
   
<span class="token comment">// build request heads</span>
private Headers headers <span class="token operator">=</span> Headers<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"APP_ID"</span><span class="token punctuation">,</span> APP_ID<span class="token punctuation">,</span> <span class="token string">"APP_SECRET"</span><span class="token punctuation">,</span> APP_SECRET<span class="token punctuation">)</span>
</code></pre>
<h3><a id="23__invoke__pay_channelhttpswwwkancloudcnmandouappinchinapay965247__API__to_get_the_pay_channel_60"></a>2.3  invoke  <a href="https://www.kancloud.cn/mandou/appinchinapay/965247" target="_blank">pay channel</a>  API  to get the pay channel</h3>
<pre><code class="ಠhighlight-container">
<span class="token comment">// the Request object is from okhttp3  jar</span>
Request request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Request<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span>Api<span class="token punctuation">.</span><span class="token function">buildUrl</span><span class="token punctuation">(</span>GET_PAY_TOOLS<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Call call   <span class="token operator">=</span>  <span class="token keyword">new</span>  <span class="token class-name">OkHttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newCall</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>

<span class="token comment">// call response</span>
call<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
       <span class="token comment">// if response failure </span>
     @Override
     public void <span class="token function">onFailure</span><span class="token punctuation">(</span>Call call<span class="token punctuation">,</span> IOException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Looper<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>MainActivity<span class="token punctuation">.</span>this<span class="token punctuation">,</span> <span class="token string">"request failed"</span><span class="token punctuation">,</span>         Toast<span class="token punctuation">.</span>LENGTH_LONG<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Looper<span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
    
    <span class="token comment">// if request success</span>
    @Override
    public void <span class="token function">onResponse</span><span class="token punctuation">(</span>Call call<span class="token punctuation">,</span> Response response<span class="token punctuation">)</span> throws IOException <span class="token punctuation">{</span>
            String s <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"onResponse: "</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>

            JSONObject result <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>

            String code <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// if the response is successful ,the code = "0"</span>
            <span class="token comment">// for more detailed response information ,view the </span>
            <span class="token comment">// payTools.json API  </span>
            <span class="token comment">// https://www.kancloud.cn/mandou/appinchinapay/965247</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"0"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token comment">// get the payTools.json api response data</span>
                <span class="token comment">// to init you app pay view</span>
                <span class="token comment">// the doInitPayTools() method detail is on the next step</span>
                <span class="token function">doInitPayTools</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getJSONArray</span><span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

                Looper<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Toast<span class="token punctuation">.</span>makeText（<span class="token function">getApplication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"msg"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Toast<span class="token punctuation">.</span>LENGTH_LONG<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Looper<span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre>
<h3><a id="24_Get__pay_channel_api_result__and_init_app_view_114"></a>2.4 Get  <code>pay channel</code> api result , and init app view</h3>
<pre><code class="ಠhighlight-container"><span class="token comment">// payToolList is payTools.json api result</span>
private void <span class="token function">doInitPayTools</span><span class="token punctuation">(</span>JSONArray payToolList<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>payToolList <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> payToolList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>MainActivity<span class="token punctuation">.</span>this<span class="token punctuation">,</span> <span class="token string">"your app has not regested"</span><span class="token punctuation">,</span> Toast<span class="token punctuation">.</span>LENGTH_LONG<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>int i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> payToolList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            JSONObject payTool <span class="token operator">=</span> payToolList<span class="token punctuation">.</span><span class="token function">getJSONObject</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            String appId <span class="token operator">=</span> payTool<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// get pay channel</span>
            String payChannel <span class="token operator">=</span> payTool<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"payChannel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            Message msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Bundle bundle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bundle<span class="token punctuation">.</span><span class="token function">putString</span><span class="token punctuation">(</span><span class="token string">"appId"</span><span class="token punctuation">,</span> appId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            msg<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>bundle<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"WECHAT"</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>payChannel<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                msg<span class="token punctuation">.</span>what <span class="token operator">=</span> MSG_SHOW_WECHAT<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"ALIPAY"</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>payChannel<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                msg<span class="token punctuation">.</span>what <span class="token operator">=</span> MSG_SHOW_ALIPAY<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            handler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<p><strong>Handle process message</strong></p>
<pre><code class="ಠhighlight-container">
private Handler handler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        @Override
        public void <span class="token function">handleMessage</span><span class="token punctuation">(</span>Message msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            String appId <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"appId"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            switch <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    case MSG_SHOW_ALIPAY<span class="token punctuation">:</span>
                        <span class="token comment">//TODO:  to do your business  or init view</span>
                        
                        <span class="token comment">// request apliPay, the method is at next step</span>
                        <span class="token function">sendPayRequest</span><span class="token punctuation">(</span><span class="token string">"ALIPAY"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    default<span class="token punctuation">:</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<h3><a id="25_Request_Create_Order_Api_171"></a>2.5 Request Create Order Api</h3>
<pre><code class="ಠhighlight-container">private  void  <span class="token function">sendPayRequest</span><span class="token punctuation">(</span>final  String  payChannel<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// build the request parameter</span>
    Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"amount"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span>amountStr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"bizNo"</span><span class="token punctuation">,</span> bizNoStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"goodsTitle"</span><span class="token punctuation">,</span> titleStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"payChannel"</span><span class="token punctuation">,</span> payChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// build the request object</span>
        Request request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Request<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span>CREATE_ORDER<span class="token punctuation">)</span>
                 <span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>RequestBody<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>MediaType<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">"application/json;charset=UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> JSONObject<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// callback process</span>
Call call <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">OkHttp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newCall</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
call<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// request failed callback </span>
            @Override
            public void <span class="token function">onFailure</span><span class="token punctuation">(</span>Call call<span class="token punctuation">,</span> IOException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Looper<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>MainActivity<span class="token punctuation">.</span>this<span class="token punctuation">,</span> <span class="token string">"request failed"</span><span class="token punctuation">,</span> Toast<span class="token punctuation">.</span>LENGTH_LONG<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Looper<span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// success response</span>
            @Override
            public void <span class="token function">onResponse</span><span class="token punctuation">(</span>Call call<span class="token punctuation">,</span> Response response<span class="token punctuation">)</span> throws IOException <span class="token punctuation">{</span>

                <span class="token comment">// get  response data</span>
                String s <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"onResponse: "</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>

                JSONObject result <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
                String code <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                
                <span class="token comment">// if request is successful , code = "0"</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"0"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    JSONObject data <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getJSONObject</span><span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    data<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"payChannel"</span><span class="token punctuation">,</span> payChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    Message msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    Bundle bundle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    bundle<span class="token punctuation">.</span><span class="token function">putSerializable</span><span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    
                    <span class="token comment">// handler process your business</span>
                    msg<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>bundle<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    msg<span class="token punctuation">.</span>what <span class="token operator">=</span> MSG_CREATE_ORDER_RESP<span class="token punctuation">;</span>
                    handler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    Looper<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>MainActivity<span class="token punctuation">.</span>this<span class="token punctuation">,</span> result<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"msg"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Toast<span class="token punctuation">.</span>LENGTH_LONG<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    Looper<span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre>
<p><strong>handle process</strong></p>
<pre><code class="ಠhighlight-container">private Handler handler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        @Override
        public void <span class="token function">handleMessage</span><span class="token punctuation">(</span>Message msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           
            switch <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                case MSG_CREATE_ORDER_RESP<span class="token punctuation">:</span>

                    <span class="token comment">// to call alipay</span>
                   JSONObject data <span class="token operator">=</span> <span class="token punctuation">(</span>JSONObject<span class="token punctuation">)</span> bundle<span class="token punctuation">.</span><span class="token function">getSerializable</span><span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// the callAlipay(data) method is at next step</span>
                    <span class="token function">callAlipay</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
             
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre>
<h3><a id="26_Call_Alipay_260"></a>2.6 Call Alipay</h3>
<pre><code class="ಠhighlight-container">private void <span class="token function">callAlipay</span><span class="token punctuation">(</span>JSONObject data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        String sign <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"sign"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// remove useless key-value parameter</span>
        data<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">"sign"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        data<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">"payChannel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// build request aplipay orderinfo paramter</span>
        StringBuffer sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span>String k<span class="token punctuation">:</span> data<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'='</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>URLEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UnsupportedEncodingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'&amp;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"sign="</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>URLEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>sign<span class="token punctuation">,</span> <span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UnsupportedEncodingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        final String orderInfo <span class="token operator">=</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> orderInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        
        <span class="token comment">// request aplipay at new thread</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            @Override
            public void <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token comment">// Request Alipay </span>
                PayTask alipay <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PayTask</span><span class="token punctuation">(</span>MainActivity<span class="token punctuation">.</span>this<span class="token punctuation">)</span><span class="token punctuation">;</span>
                Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> result <span class="token operator">=</span> alipay<span class="token punctuation">.</span><span class="token function">payV2</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                
                <span class="token comment">// TODO :</span>
                <span class="token comment">// if you want to show pay result page ,you can use Handle to process</span>

               <span class="token comment">// Message msg = new Message();</span>
                <span class="token comment">//msg.what = "pay_success";</span>
                <span class="token comment">//msg.obj = result;</span>
                <span class="token comment">//handler.sendMessage(msg);</span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre>
<hr/>
<h1><a id="3Full_Demo_319"></a>3.Full Demo</h1>
<h3><a id="31_Full_demo_url_320"></a>3.1 Full demo url</h3>
<p><a href="https://github.com/yangfjiahl/Voucher.git" target="_blank">https://github.com/yangfjiahl/Voucher.git</a></p>
</div><div class="article-navigation"><span class="prev">Previous: <a href="HowtoFireaPay.html">How to Fire a Pay</a></span><span class="next">Next: <a href="iOS.html">iOS</a></span></div><div class="article-foot"></div></div></div></div></div></div><script src="asset/reader.js"></script><script src="asset/plugins/api/reader/index.js"></script><script src="asset/plugins/youku/reader/index.js"></script><script src="asset/plugins/highlight/reader/index.js"></script><script src="asset/plugins/cloud-image/reader/index.js"></script><script src="asset/plugins/theme-default/reader/index.js"></script><script src="asset/plugins/search/reader/index.js"></script><script type="application/payload+json">{"config":{"plugins":["api","highlight","youku","cloud-image","search"],"pluginsConfig":{"theme-default":{"auto_open":true,"logo":[]},"api":{"default":{"url":"http:\/\/cashier.51mandou.com","contentType":"application\/json","headers":{"APP_ID":"20190307001","APP_SECRET":"123"},"security":[]}}},"cover":"cover.jpg","title":"AppInChinaPay","id":418460,"description":"AppInChinaServices.com"},"summary":[{"level":"1","title":"Introduction","ref":"Introduction.md","path":"Introduction.html","articles":[]},{"level":"2","title":"App Configuration","ref":"AppConfiguration.md","path":"AppConfiguration.html","articles":[]},{"level":"3","title":"SDK Installation","ref":"SDKInstallation.md","path":"SDKInstallation.html","articles":[{"level":"3.1","title":"Android SDK","ref":"AndroidSdk.md","path":"AndroidSdk.html","articles":[]},{"level":"3.2","title":"iOS SDK","ref":"iOSSdk.md","path":"iOSSdk.html","articles":[]}]},{"level":"4","title":"API","ref":"API.md","path":"API.html","articles":[{"level":"4.1","title":"API Authentication","ref":"APIAuthentication.md","path":"APIAuthentication.html","articles":[]},{"level":"4.2","title":"Pay Channel Init","ref":"PayToolsInit.md","path":"PayToolsInit.html","articles":[]},{"level":"4.3","title":"Create Order","ref":"Order.md","path":"Order.html","articles":[]},{"level":"4.4","title":"Query Order","ref":"QueryOrder.md","path":"QueryOrder.html","articles":[]},{"level":"4.5","title":"Query Order List","ref":"QueryOrderList.md","path":"QueryOrderList.html","articles":[]}]},{"level":"5","title":"Initiate Payment","ref":"InitiatePayment.md","path":"InitiatePayment.html","articles":[{"level":"5.1","title":"How to Fire a Pay","ref":"HowtoFireaPay.md","path":"HowtoFireaPay.html","articles":[]},{"level":"5.2","title":"Android","ref":"Android.md","path":"Android.html","articles":[]},{"level":"5.3","title":"iOS","ref":"iOS.md","path":"iOS.html","articles":[]}]},{"level":"6","title":"Purchase Restore","ref":"PurchaseRestore.md","path":"PurchaseRestore.html","articles":[{"level":"6.1","title":"Basic Principles","ref":"BasicPrinciples.md","path":"BasicPrinciples.html","articles":[]},{"level":"6.2","title":"Authentication","ref":"Authentication.md","path":"Authentication.html","articles":[]},{"level":"6.3","title":"Sms Code","ref":"SmsCode.md","path":"SmsCode.html","articles":[]},{"level":"6.4","title":"Logon Status Check","ref":"LogonStatusCheck.md","path":"LogonStatusCheck.html","articles":[]},{"level":"6.5","title":"Typical Scenarios","ref":"TypicalScenarios.md","path":"TypicalScenarios.html","articles":[]}]},{"level":"7","title":"Help","ref":"Help.md","path":"Help.html","articles":[{"level":"7.1","title":"Video","ref":"Video.md","path":"Video.html","articles":[]},{"level":"7.2","title":"Frequently Asked Questions","ref":"faq.md","path":"faq.html","articles":[]},{"level":"7.3","title":"Update Notes","ref":"UpdateNotes.md","path":"UpdateNotes.html","articles":[]}]}],"article":{"path":"Android.html","ref":"Android.md","title":"Android","content":"# 1. Android for wechat \n\n### 1.1 Android Java:\n\n~~~\nJSONObject data = (JSONObject) bundle.getSerializable(\"data\");\n\/\/ {appid=wx7f229e38a04f2bec, noncestr=LXyHXBUVh39LYBrK, package=Sign=WXPay, partnerid=1523808161, prepayid=wx2613502950188989bf5937ec1163319167, sign=50F044924686609080E94B7C6EB7969E, timestamp=1551160229}\nPayReq req = new PayReq();\nreq.appId = data.getString(\"appid\");\nreq.partnerId = data.getString(\"partnerid\");\nreq.prepayId = data.getString(\"prepayid\");\nreq.nonceStr = data.getString(\"noncestr\");\nreq.timeStamp = data.getString(\"timestamp\");\nreq.packageValue = data.getString(\"package\");\nreq.sign = data.getString(\"sign\");\n​\nLog.d(TAG, req.checkArgs() + \" param check result\");\nboolean v = api.sendReq(req);\nLog.d(TAG, v + \" startup pay result\");\n~~~\n\n\n\n*****\n# 2.Android for Alipay\n\n### 2.1 Init Alipay parameter\n~~~          \n\/\/ app id\nprivate final String APP_ID = \"20190307001\";\n       \n~~~\n\n ### 2.2 Init the Api parameter \n\n~~~\n\n\/\/ pay channel API\nprivate final  String  BASE_URL =  \"http:\/\/cashier.51mandou.com\";\nprivate final String GET_PAY_TOOLS = BASE_URL + \"\/payTools.json\" ;\n\n\/\/ createOrder API\npublic  final  String  CREATE_ORDER  =  BASE_URL+\"\/order.json\";\n\n \/\/ order amount \nString amountStr = \"99\";\r\n\n\/\/ your business No.\nString bizNoStr = \"biz No\" ;\r\n\n\/\/ your goods title\nString titleStr = \" test goods title\";\n\n\/\/ your app_id and secret\nprivate final String APP_SECRET = \"123\";\n   \n\/\/ build request heads\nprivate Headers headers = Headers.of(\"APP_ID\", APP_ID, \"APP_SECRET\", APP_SECRET)\n~~~\n\n### 2.3  invoke  [pay channel](https:\/\/www.kancloud.cn\/mandou\/appinchinapay\/965247)  API  to get the pay channel\n~~~\n\n\/\/ the Request object is from okhttp3  jar\nRequest request = new Request.Builder()\r\n                .url(Api.buildUrl(GET_PAY_TOOLS))\r\n                .headers(headers)\r\n                .build();\n\nCall call   =  new  OkHttpClient().newCall(request);;\n\n\/\/ call response\ncall.enqueue(new Callback() {\n    \n       \/\/ if response failure \n     @Override\r\n     public void onFailure(Call call, IOException e) {\r\n            Looper.prepare();\r\n            Toast.makeText(MainActivity.this, \"request failed\",         Toast.LENGTH_LONG).show();\r\n            Looper.loop();\r\n     }\n    \n    \/\/ if request success\n    @Override\r\n    public void onResponse(Call call, Response response) throws IOException {\r\n            String s = response.body().string();\r\n            Log.d(TAG, \"onResponse: \" + s);\r\n\r\n            JSONObject result = JSON.parseObject(s);\r\n\r\n            String code = result.getString(\"code\");\r\n\r            \/\/ if the response is successful ,the code = \"0\"\n            \/\/ for more detailed response information ,view the \n            \/\/ payTools.json API  \n            \/\/ https:\/\/www.kancloud.cn\/mandou\/appinchinapay\/965247\n            if (\"0\".equals(code)) {\r\n\n                \/\/ get the payTools.json api response data\n                \/\/ to init you app pay view\n                \/\/ the doInitPayTools() method detail is on the next step\n                doInitPayTools(result.getJSONArray(\"data\"));\r\n\n            } else {\r\n\n                Looper.prepare();\r\n                Toast.makeText（getApplication(), result.getString(\"msg\"), Toast.LENGTH_LONG).show();\r\n                Looper.loop();\r\n\n            }\r\n        }\r\n    });\n\n~~~\n### 2.4 Get  `pay channel` api result , and init app view\n~~~\n\/\/ payToolList is payTools.json api result\nprivate void doInitPayTools(JSONArray payToolList) {\r\n\n        if (payToolList == null || payToolList.size() == 0) {\r\n            Toast.makeText(MainActivity.this, \"your app has not regested\", Toast.LENGTH_LONG).show();\r\n            return;\r\n        }\r\n\r\n        for (int i = 0; i < payToolList.size(); i++) {\r\n\n            JSONObject payTool = payToolList.getJSONObject(i);\r\n            String appId = payTool.getString(\"id\");\r\n\n            \/\/ get pay channel\n            String payChannel = payTool.getString(\"payChannel\");\r\n\r\n            Message msg = new Message();\r\n            Bundle bundle = new Bundle();\r\n            bundle.putString(\"appId\", appId);\r\n            msg.setData(bundle);\r\n\r\n            if (\"WECHAT\".equalsIgnoreCase(payChannel)) {\r\n                msg.what = MSG_SHOW_WECHAT;\r\n            } else if (\"ALIPAY\".equalsIgnoreCase(payChannel)) {\r\n                msg.what = MSG_SHOW_ALIPAY;\r\n            }\r\n\r\n            handler.sendMessage(msg);\r\n        }\r\n    }\n~~~\n\n**Handle process message**\n~~~\n\nprivate Handler handler = new Handler() {\r\n\r\n        @Override\r\n        public void handleMessage(Message msg) {\r\n            String appId = msg.getData().getString(\"appId\");\r\n\r\n            switch (msg.what) {\r\n                    case MSG_SHOW_ALIPAY:\r\n                        \/\/TODO:  to do your business  or init view\n                        \n                        \/\/ request apliPay, the method is at next step\n                        sendPayRequest(\"ALIPAY\");\n                        break;\r\n                    default:\n                        break;\n            }\r\n        }\r\n    };\n~~~\n\n### 2.5 Request Create Order Api \n~~~\nprivate  void  sendPayRequest(final  String  payChannel) {\n\n    \/\/ build the request parameter\n    Map<String, Object> params = new HashMap<>();\r\n        params.put(\"amount\", new BigDecimal(amountStr).multiply(new BigDecimal(100)).longValue());\r\n        params.put(\"bizNo\", bizNoStr);\r\n        params.put(\"goodsTitle\", titleStr);\r\n        params.put(\"payChannel\", payChannel);\n\n    \/\/ build the request object\n        Request request = new Request.Builder()\r\n                .url(CREATE_ORDER)\n                 .post(RequestBody.create(MediaType.parse(\"application\/json;charset=UTF-8\"), JSONObject.toJSONString(params)))\r\n                .headers(headers)\r\n                .build();\n}\n\n\/\/ callback process\nCall call =  new OkHttp().newCall(request);\ncall.enqueue(new Callback() {\r\n            \/\/ request failed callback \n            @Override\r\n            public void onFailure(Call call, IOException e) {\r\n                Looper.prepare();\r\n                Toast.makeText(MainActivity.this, \"request failed\", Toast.LENGTH_LONG).show();\r\n                Looper.loop();\r\n            }\n\n            \/\/ success response\n            @Override\r\n            public void onResponse(Call call, Response response) throws IOException {\r\n\n                \/\/ get  response data\n                String s = response.body().string();\r\n\r                Log.d(TAG, \"onResponse: \" + s);\r\n\n                JSONObject result = JSON.parseObject(s);\r\n                String code = result.getString(\"code\");\r\n\r                \n                \/\/ if request is successful , code = \"0\"\n                if (\"0\".equals(code)) {\r\n                    JSONObject data = result.getJSONObject(\"data\");\r\n                    data.put(\"payChannel\", payChannel);\r\n\r\n                    Message msg = new Message();\r\n                    Bundle bundle = new Bundle();\r\n                    bundle.putSerializable(\"data\", data);\r\n                    \n                    \/\/ handler process your business\n                    msg.setData(bundle);\r\n                    msg.what = MSG_CREATE_ORDER_RESP;\r\n                    handler.sendMessage(msg);\r\n\n                } else {\r\n                    Looper.prepare();\r\n                    Toast.makeText(MainActivity.this, result.getString(\"msg\"), Toast.LENGTH_LONG).show();\r\n                    Looper.loop();\r\n                }\r\n            }\r\n        });\r\n    }\n\n~~~\n**handle process**\n~~~\nprivate Handler handler = new Handler() {\r\n\r\n        @Override\r\n        public void handleMessage(Message msg) {\r\n           \r\n            switch (msg.what) {\r\n                case MSG_CREATE_ORDER_RESP:\r\n\n                    \/\/ to call alipay\n                   JSONObject data = (JSONObject) bundle.getSerializable(\"data\");\n\n                    \/\/ the callAlipay(data) method is at next step\n                    callAlipay(data);\n                    break;\r\n             \n            }\r\n        }\r\n    };\n\n~~~\n### 2.6 Call Alipay\n~~~\nprivate void callAlipay(JSONObject data) {\r\n        String sign = data.getString(\"sign\");\r\n\n        \/\/ remove useless key-value parameter\n        data.remove(\"sign\");\r\n        data.remove(\"payChannel\");\r\n        \n        \/\/ build request aplipay orderinfo paramter\n        StringBuffer sb = new StringBuffer();\r\n        for(String k: data.keySet()) {\r\n            sb.append(k);\r\n            sb.append('=');\r\n            try {\r\n                sb.append(URLEncoder.encode(data.getString(k), \"utf-8\"));\r\n            } catch (UnsupportedEncodingException e) {\r\n                e.printStackTrace();\r\n            }\r\n            sb.append('&');\r\n        }\r\n\r\n        try {\r\n            sb.append(\"sign=\").append(URLEncoder.encode(sign, \"utf-8\"));\r\n        } catch (UnsupportedEncodingException e) {\r\n            e.printStackTrace();\r\n        }\r\n\r\n        final String orderInfo = sb.toString();\r\n\r\n        Log.d(TAG, orderInfo);\r\n\r        \n        \/\/ request aplipay at new thread\n        new Thread(new Runnable() {\r\n\r\n            @Override\r\n            public void run() {\r\n\n                \/\/ Request Alipay \n                PayTask alipay = new PayTask(MainActivity.this);\r\n                Map<String, String> result = alipay.payV2(orderInfo, true);\r\n\r                \n                \/\/ TODO :\n                \/\/ if you want to show pay result page ,you can use Handle to process\n\n               \/\/ Message msg = new Message();\r\n                \/\/msg.what = \"pay_success\";\r\n                \/\/msg.obj = result;\r\n                \/\/handler.sendMessage(msg);\r\n\n            }\r\n        }).start();\r\n    }\r\n\n~~~\n\n*****\n# 3.Full Demo\n### 3.1 Full demo url\n\n [https:\/\/github.com\/yangfjiahl\/Voucher.git](https:\/\/github.com\/yangfjiahl\/Voucher.git)"},"options":{"base":".\/","environment":"reader"},"style":""}</script><script type="text/javascript">kancloud.bootstrap('app');</script></body></html>