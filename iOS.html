<html><head><meta charSet="utf-8"/><title data-react-helmet="true">iOS · AppInChinaPay</title><meta data-react-helmet="true" name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/><link rel="stylesheet" href="asset/plugins/theme-default/reader/style.css"/><style data-react-helmet="true" type="text/css">.ಠhighlight-container code[class*=language-],.ಠhighlight-container pre[class*=language-]{color:#000;background:none;text-shadow:0 1px #fff;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}.ಠhighlight-container code[class*=language-]::-moz-selection,.ಠhighlight-container code[class*=language-] ::-moz-selection,.ಠhighlight-container pre[class*=language-]::-moz-selection,.ಠhighlight-container pre[class*=language-] ::-moz-selection{text-shadow:none;background:#b3d4fc}.ಠhighlight-container code[class*=language-]::selection,.ಠhighlight-container code[class*=language-] ::selection,.ಠhighlight-container pre[class*=language-]::selection,.ಠhighlight-container pre[class*=language-] ::selection{text-shadow:none;background:#b3d4fc}@media print{.ಠhighlight-container code[class*=language-],.ಠhighlight-container pre[class*=language-]{text-shadow:none}}.ಠhighlight-container pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}.ಠhighlight-container :not(pre)>code[class*=language-],.ಠhighlight-container pre[class*=language-]{background:#f5f2f0}.ಠhighlight-container :not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.ಠhighlight-container .token.cdata,.ಠhighlight-container .token.comment,.ಠhighlight-container .token.doctype,.ಠhighlight-container .token.prolog{color:#708090}.ಠhighlight-container .token.punctuation{color:#999}.ಠhighlight-container .namespace{opacity:.7}.ಠhighlight-container .token.boolean,.ಠhighlight-container .token.constant,.ಠhighlight-container .token.deleted,.ಠhighlight-container .token.number,.ಠhighlight-container .token.property,.ಠhighlight-container .token.symbol,.ಠhighlight-container .token.tag{color:#905}.ಠhighlight-container .token.attr-name,.ಠhighlight-container .token.builtin,.ಠhighlight-container .token.char,.ಠhighlight-container .token.inserted,.ಠhighlight-container .token.selector,.ಠhighlight-container .token.string{color:#690}.ಠhighlight-container .language-css .token.string,.ಠhighlight-container .style .token.string,.ಠhighlight-container .token.entity,.ಠhighlight-container .token.operator,.ಠhighlight-container .token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.ಠhighlight-container .token.atrule,.ಠhighlight-container .token.attr-value,.ಠhighlight-container .token.keyword{color:#07a}.ಠhighlight-container .token.class-name,.ಠhighlight-container .token.function{color:#dd4a68}.ಠhighlight-container .token.important,.ಠhighlight-container .token.regex,.ಠhighlight-container .token.variable{color:#e90}.ಠhighlight-container .token.bold,.ಠhighlight-container .token.important{font-weight:700}.ಠhighlight-container .token.italic{font-style:italic}.ಠhighlight-container .token.entity{cursor:help}</style><style>
.ಠapi-actions{
    margin-left: 20px;
}
.ಠapi-url{
margin-left:15px;
}
.ui.icon.ಠapi-compass{
    display: none;
}
</style></head><body><div id="main"><div class="window-container"><img src="cover.jpg" style="position:absolute;visibility:hidden"/><div><div class="Loading__loading___1m_fZ"><div class="Loading__bar___21yOt" style="background:#21ba45;width:0%;display:none"><div class="Loading__peg___3Y_28"></div></div></div><div class="Loading__spinner___11Pm4"><div class="Loading__icon___3OOyu" style="display:none;border-color:#21ba45"></div></div></div><div class="window-body"><div class="sidebar"><div class="sidebar-header"><a href="." class="title">AppInChinaPay</a><div class="search-form"><div class="ui small fluid icon input"><input type="text" placeholder="Search..."/><i class="icon search"></i></div></div></div><div class="sidebar-body"><div class="catalog-body"><ul><li class="open"><div class="wholerow"></div><i class="icon"></i><a href="Introduction.html" class="text">Introduction</a></li><li class="open"><div class="wholerow"></div><i class="icon"></i><a href="AppConfiguration.html" class="text">App Configuration</a></li><li class="open"><div class="wholerow"></div><i class="icon caret down"></i><a href="SDKInstallation.html" class="text">SDK Installation</a><ul><li class=""><div class="wholerow"></div><i class="icon"></i><a href="AndroidSdk.html" class="text">Android SDK</a></li><li class=""><div class="wholerow"></div><i class="icon"></i><a href="iOSSdk.html" class="text">iOS SDK</a></li></ul></li><li class="open"><div class="wholerow"></div><i class="icon caret down"></i><a href="API.html" class="text">API</a><ul><li class=""><div class="wholerow"></div><i class="icon"></i><a href="APIAuthentication.html" class="text">API Authentication</a></li><li class=""><div class="wholerow"></div><i class="icon"></i><a href="PayToolsInit.html" class="text">Pay Channel Init</a></li><li class=""><div class="wholerow"></div><i class="icon"></i><a href="Order.html" class="text">Create Order</a></li><li class=""><div class="wholerow"></div><i class="icon"></i><a href="QueryOrder.html" class="text">Query Order</a></li><li class=""><div class="wholerow"></div><i class="icon"></i><a href="QueryOrderList.html" class="text">Query Order List</a></li></ul></li><li class="open"><div class="wholerow"></div><i class="icon caret down"></i><a href="InitiatePayment.html" class="text">Initiate Payment</a><ul><li class=""><div class="wholerow"></div><i class="icon"></i><a href="HowtoFireaPay.html" class="text">How to Fire a Pay</a></li><li class=""><div class="wholerow"></div><i class="icon"></i><a href="Android.html" class="text">Android</a></li><li class=""><div class="wholerow"></div><i class="icon"></i><a href="iOS.html" class="text">iOS</a></li></ul></li><li class="open"><div class="wholerow"></div><i class="icon caret down"></i><a href="PurchaseRestore.html" class="text">Purchase Restore</a><ul><li class=""><div class="wholerow"></div><i class="icon"></i><a href="BasicPrinciples.html" class="text">Basic Principles</a></li><li class=""><div class="wholerow"></div><i class="icon"></i><a href="Authentication.html" class="text">Authentication</a></li><li class=""><div class="wholerow"></div><i class="icon"></i><a href="SmsCode.html" class="text">Sms Code</a></li><li class=""><div class="wholerow"></div><i class="icon"></i><a href="LogonStatusCheck.html" class="text">Logon Status Check</a></li><li class=""><div class="wholerow"></div><i class="icon"></i><a href="TypicalScenarios.html" class="text">Typical Scenarios</a></li></ul></li><li class="open"><div class="wholerow"></div><i class="icon caret down"></i><a href="Help.html" class="text">Help</a><ul><li class=""><div class="wholerow"></div><i class="icon"></i><a href="Video.html" class="text">Video</a></li><li class=""><div class="wholerow"></div><i class="icon"></i><a href="faq.html" class="text">Frequently Asked Questions</a></li><li class=""><div class="wholerow"></div><i class="icon"></i><a href="UpdateNotes.html" class="text">Update Notes</a></li></ul></li></ul></div></div><div class="sidebar-copyright">本文档使用 <a href="https://www.kancloud.cn" target="_blank">看云</a> 构建</div></div><div class="workspace"><div class="article"><div class="article-head"><div class="left tools"><a class="item icon"><i class="icon align justify"></i></a></div><h1>iOS</h1><div class="right tools"><div role="listbox" aria-expanded="false" class="ui top right pointing dropdown item" tabindex="0"><div class="text" role="alert" aria-live="polite"></div><i aria-hidden="true" class="share alternate icon"></i><div class="menu transition"><div role="option" class="item"><i aria-hidden="true" class="linkify icon"></i><span class="text">复制链接</span></div><div role="option" class="item"><i aria-hidden="true" class="qq icon"></i><span class="text">腾讯QQ</span></div><div role="option" class="item"><i aria-hidden="true" class="weibo icon"></i><span class="text">新浪微博</span></div><div class="header"><p><i class="icon wechat"></i><span class="text">微信扫一扫</span></p><img src="https://bshare.optimix.asia/barCode?site=weixin&amp;url=file%3A%2F%2F.%2Fcontent%2FiOS.md"/></div></div></div></div></div><div class="article-body kancloud-markdown-body"><p class="align-center"><strong>iOS</strong></p>
<h1><a id="1iOS_for_Wechat_2"></a>1.iOS for Wechat</h1>
<p>TODO:</p>
<hr/>
<h1><a id="2_iOS_for_Alipay_6"></a>2. iOS for Alipay</h1>
<h3><a id="21_init_Alipay_parameter_10"></a>2.1. init Alipay parameter</h3>
<pre><code class="ಠhighlight-container">NSString <span class="token operator">*</span>appID <span class="token operator">=</span> @<span class="token string">" 129999000000"</span><span class="token punctuation">;</span>

</code></pre>
<h3><a id="22_init_api_parameter_17"></a>2.2. init api parameter</h3>
<pre><code class="ಠhighlight-container">
<span class="token comment">// order amount</span>
NSNumber <span class="token operator">*</span>amountStr  <span class="token operator">=</span><span class="token punctuation">[</span>NSNumber numberWithFloat<span class="token punctuation">:</span><span class="token number">99.01</span><span class="token punctuation">]</span> <span class="token punctuation">;</span>

<span class="token comment">// your business NO.</span>
NSString  <span class="token operator">*</span>bizNoStr <span class="token operator">=</span> @<span class="token string">"biz20190001"</span> <span class="token punctuation">;</span>

<span class="token comment">// your goods title</span>
NSString <span class="token operator">*</span>titleStr <span class="token operator">=</span> @<span class="token string">"test goods title "</span><span class="token punctuation">;</span>

<span class="token comment">// pay channel API</span>
static NSString  <span class="token operator">*</span>BASE_URL <span class="token operator">=</span>  <span class="token string">"http://cashier.51mandou.com"</span><span class="token punctuation">;</span>
static NSString <span class="token operator">*</span>GET_PAY_TOOLS <span class="token operator">=</span> BASE_URL <span class="token operator">+</span> <span class="token string">"/payTools.json"</span> <span class="token punctuation">;</span>

<span class="token comment">// create Order API</span>
static NSString  <span class="token operator">*</span>CREATE_ORDER  <span class="token operator">=</span>  BASE_URL<span class="token operator">+</span><span class="token string">"/order.json"</span><span class="token punctuation">;</span>

<span class="token comment">// your app_id </span>
final NSString APP_ID <span class="token operator">=</span> <span class="token string">"20190307001"</span><span class="token punctuation">;</span>

<span class="token comment">//  Api secret</span>
final NSString APP_SECRET <span class="token operator">=</span> <span class="token string">"123"</span><span class="token punctuation">;</span>

</code></pre>
<h3><a id="23_Get_the_pay_channel_by_Pay_Channel_Api_44"></a>2.3. Get the pay channel by <code>Pay Channel</code> Api</h3>
<p>Import AFHTTPS package at file header</p>
<pre><code class="ಠhighlight-container">
AFHTTPSessionManager <span class="token operator">*</span>manger <span class="token operator">=</span> <span class="token punctuation">[</span>AFHTTPSessionManager manager<span class="token punctuation">]</span><span class="token punctuation">;</span>
AFHTTPRequestSerializer <span class="token operator">*</span>requestSerializer <span class="token operator">=</span>  <span class="token punctuation">[</span>AFJSONRequestSerializer serializer<span class="token punctuation">]</span><span class="token punctuation">;</span>

NSDictionary <span class="token operator">*</span>headerFieldValueDictionary <span class="token operator">=</span> @<span class="token punctuation">{</span>@<span class="token string">"version"</span><span class="token punctuation">:</span>@<span class="token string">"1.0"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>headerFieldValueDictionary <span class="token operator">!=</span> nil<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>NSString <span class="token operator">*</span>httpHeaderField <span class="token keyword">in</span> headerFieldValueDictionary<span class="token punctuation">.</span>allKeys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        NSString <span class="token operator">*</span>value <span class="token operator">=</span> headerFieldValueDictionary<span class="token punctuation">[</span>httpHeaderField<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span>requestSerializer setValue<span class="token punctuation">:</span>value forHTTPHeaderField<span class="token punctuation">:</span>httpHeaderField<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
manger<span class="token punctuation">.</span>requestSerializer <span class="token operator">=</span> requestSerializer<span class="token punctuation">;</span>
<span class="token punctuation">[</span>manger GET<span class="token punctuation">:</span>@<span class="token string">"url"</span> parameters<span class="token punctuation">:</span>nil  progress<span class="token punctuation">:</span>nil success<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">(</span>NSURLSessionDataTask <span class="token operator">*</span> _Nonnull task<span class="token punctuation">,</span> id  _Nullable responseObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       
   <span class="token punctuation">}</span> failure<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">(</span>NSURLSessionDataTask <span class="token operator">*</span> _Nullable task<span class="token punctuation">,</span> NSError <span class="token operator">*</span> _Nonnull error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       
<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre>
<p>request the api</p>
<p>get the response</p>
<h3><a id="24_Create_your_order_by_Create_Order_Api_73"></a>2.4. Create your order by <code>Create Order</code> Api</h3>
<p>request the api</p>
<p>get the response</p>
<h3><a id="25__Request_Alipay_to_pay_your_order_79"></a>2.5 . Request Alipay to pay your order</h3>
<h3><a id="26_Query_your_order_list_81"></a>2.6. Query your order list</h3>
<p>2.1 iOS Object-c for alipay</p>
<pre><code class="ಠhighlight-container"><span class="token comment">//</span>
<span class="token comment">// 选中商品调用支付宝极简支付</span>
<span class="token comment">//</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>void<span class="token punctuation">)</span>doAPPay
<span class="token punctuation">{</span>
    <span class="token comment">// 重要说明</span>
    <span class="token comment">// 这里只是为了方便直接向商户展示支付宝的整个支付流程；所以Demo中加签过程直接放在客户端完成；</span>
    <span class="token comment">// 真实App里，privateKey等数据严禁放在客户端，加签过程务必要放在服务端完成；</span>
    <span class="token comment">// 防止商户私密数据泄露，造成不必要的资金损失，及面临各种安全风险；</span>
    <span class="token comment">/*============================================================================*/</span>
    <span class="token comment">/*=======================需要填写商户app申请的===================================*/</span>
    <span class="token comment">/*============================================================================*/</span>
    NSString <span class="token operator">*</span>appID <span class="token operator">=</span> @<span class="token string">""</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 如下私钥，rsa2PrivateKey 或者 rsaPrivateKey 只需要填入一个</span>
    <span class="token comment">// 如果商户两个都设置了，优先使用 rsa2PrivateKey</span>
    <span class="token comment">// rsa2PrivateKey 可以保证商户交易在更加安全的环境下进行，建议使用 rsa2PrivateKey</span>
    <span class="token comment">// 获取 rsa2PrivateKey，建议使用支付宝提供的公私钥生成工具生成，</span>
    <span class="token comment">// 工具地址：https://doc.open.alipay.com/docs/doc.htm?treeId=291&amp;articleId=106097&amp;docType=1</span>

    NSString <span class="token operator">*</span>rsa2PrivateKey <span class="token operator">=</span> @<span class="token string">""</span><span class="token punctuation">;</span>
    NSString <span class="token operator">*</span>rsaPrivateKey <span class="token operator">=</span> @<span class="token string">""</span><span class="token punctuation">;</span>

    <span class="token comment">/*============================================================================*/</span>
    <span class="token comment">/*============================================================================*/</span>
    <span class="token comment">/*============================================================================*/</span>
    
    <span class="token comment">//partner和seller获取失败,提示</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>appID length<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span>
        <span class="token punctuation">(</span><span class="token punctuation">[</span>rsa2PrivateKey length<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">[</span>rsaPrivateKey length<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        UIAlertController <span class="token operator">*</span>alert <span class="token operator">=</span> <span class="token punctuation">[</span>UIAlertController alertControllerWithTitle<span class="token punctuation">:</span>@<span class="token string">"提示"</span>
                                                                       message<span class="token punctuation">:</span>@<span class="token string">"缺少appId或者私钥,请检查参数设置"</span>
                                                                preferredStyle<span class="token punctuation">:</span>UIAlertControllerStyleAlert<span class="token punctuation">]</span><span class="token punctuation">;</span>
        UIAlertAction <span class="token operator">*</span>action <span class="token operator">=</span> <span class="token punctuation">[</span>UIAlertAction actionWithTitle<span class="token punctuation">:</span>@<span class="token string">"知道了"</span>
                                                         style<span class="token punctuation">:</span>UIAlertActionStyleDefault
                                                       handler<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">(</span>UIAlertAction <span class="token operator">*</span>action<span class="token punctuation">)</span><span class="token punctuation">{</span>
                                                           
                                                       <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span>alert addAction<span class="token punctuation">:</span>action<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span>self presentViewController<span class="token punctuation">:</span>alert animated<span class="token punctuation">:</span>YES completion<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/*
     *生成订单信息及签名
     */</span>
    <span class="token comment">//将商品信息赋予AlixPayOrder的成员变量</span>
    APOrderInfo<span class="token operator">*</span> order <span class="token operator">=</span> <span class="token punctuation">[</span>APOrderInfo <span class="token keyword">new</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    <span class="token comment">// NOTE: app_id设置</span>
    order<span class="token punctuation">.</span>app_id <span class="token operator">=</span> appID<span class="token punctuation">;</span>
    
    <span class="token comment">// NOTE: 支付接口名称</span>
    order<span class="token punctuation">.</span>method <span class="token operator">=</span> @<span class="token string">"alipay.trade.app.pay"</span><span class="token punctuation">;</span>
    
    <span class="token comment">// NOTE: 参数编码格式</span>
    order<span class="token punctuation">.</span>charset <span class="token operator">=</span> @<span class="token string">"utf-8"</span><span class="token punctuation">;</span>
    
    <span class="token comment">// NOTE: 当前时间点</span>
    NSDateFormatter<span class="token operator">*</span> formatter <span class="token operator">=</span> <span class="token punctuation">[</span>NSDateFormatter <span class="token keyword">new</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>formatter setDateFormat<span class="token punctuation">:</span>@<span class="token string">"yyyy-MM-dd HH:mm:ss"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    order<span class="token punctuation">.</span>timestamp <span class="token operator">=</span> <span class="token punctuation">[</span>formatter stringFromDate<span class="token punctuation">:</span><span class="token punctuation">[</span>NSDate date<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    <span class="token comment">// NOTE: 支付版本</span>
    order<span class="token punctuation">.</span>version <span class="token operator">=</span> @<span class="token string">"1.0"</span><span class="token punctuation">;</span>
    
    <span class="token comment">// NOTE: sign_type 根据商户设置的私钥来决定</span>
    order<span class="token punctuation">.</span>sign_type <span class="token operator">=</span> <span class="token punctuation">(</span>rsa2PrivateKey<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">?</span>@<span class="token string">"RSA2"</span><span class="token punctuation">:</span>@<span class="token string">"RSA"</span><span class="token punctuation">;</span>
    
    <span class="token comment">// NOTE: 商品数据</span>
    order<span class="token punctuation">.</span>biz_content <span class="token operator">=</span> <span class="token punctuation">[</span>APBizContent <span class="token keyword">new</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    order<span class="token punctuation">.</span>biz_content<span class="token punctuation">.</span>body <span class="token operator">=</span> @<span class="token string">"我是测试数据"</span><span class="token punctuation">;</span>
    order<span class="token punctuation">.</span>biz_content<span class="token punctuation">.</span>subject <span class="token operator">=</span> @<span class="token string">"1"</span><span class="token punctuation">;</span>
    order<span class="token punctuation">.</span>biz_content<span class="token punctuation">.</span>out_trade_no <span class="token operator">=</span> <span class="token punctuation">[</span>self generateTradeNO<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//订单ID（由商家自行制定）</span>
    order<span class="token punctuation">.</span>biz_content<span class="token punctuation">.</span>timeout_express <span class="token operator">=</span> @<span class="token string">"30m"</span><span class="token punctuation">;</span> <span class="token comment">//超时时间设置</span>
    order<span class="token punctuation">.</span>biz_content<span class="token punctuation">.</span>total_amount <span class="token operator">=</span> <span class="token punctuation">[</span>NSString stringWithFormat<span class="token punctuation">:</span>@<span class="token string">"%.2f"</span><span class="token punctuation">,</span> <span class="token number">0.01</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//商品价格</span>
    
    <span class="token comment">//将商品信息拼接成字符串</span>
    NSString <span class="token operator">*</span>orderInfo <span class="token operator">=</span> <span class="token punctuation">[</span>order orderInfoEncoded<span class="token punctuation">:</span>NO<span class="token punctuation">]</span><span class="token punctuation">;</span>
    NSString <span class="token operator">*</span>orderInfoEncoded <span class="token operator">=</span> <span class="token punctuation">[</span>order orderInfoEncoded<span class="token punctuation">:</span>YES<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span>@<span class="token string">"orderSpec = %@"</span><span class="token punctuation">,</span>orderInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// NOTE: 获取私钥并将商户信息签名，外部商户的加签过程请务必放在服务端，防止公私钥数据泄露；</span>
    <span class="token comment">//       需要遵循RSA签名规范，并将签名字符串base64编码和UrlEncode</span>
    NSString <span class="token operator">*</span>signedString <span class="token operator">=</span> nil<span class="token punctuation">;</span>
    APRSASigner<span class="token operator">*</span> signer <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>APRSASigner alloc<span class="token punctuation">]</span> initWithPrivateKey<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token punctuation">(</span>rsa2PrivateKey<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">?</span>rsa2PrivateKey<span class="token punctuation">:</span>rsaPrivateKey<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rsa2PrivateKey<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        signedString <span class="token operator">=</span> <span class="token punctuation">[</span>signer signString<span class="token punctuation">:</span>orderInfo withRSA2<span class="token punctuation">:</span>YES<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        signedString <span class="token operator">=</span> <span class="token punctuation">[</span>signer signString<span class="token punctuation">:</span>orderInfo withRSA2<span class="token punctuation">:</span>NO<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// NOTE: 如果加签成功，则继续执行支付</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>signedString <span class="token operator">!=</span> nil<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//应用注册scheme,在AliSDKDemo-Info.plist定义URL types</span>
        NSString <span class="token operator">*</span>appScheme <span class="token operator">=</span> @<span class="token string">"alisdkdemo"</span><span class="token punctuation">;</span>
        
        <span class="token comment">// NOTE: 将签名成功字符串格式化为订单字符串,请严格按照该格式</span>
        NSString <span class="token operator">*</span>orderString <span class="token operator">=</span> <span class="token punctuation">[</span>NSString stringWithFormat<span class="token punctuation">:</span>@<span class="token string">"%@&amp;sign=%@"</span><span class="token punctuation">,</span>
                                 orderInfoEncoded<span class="token punctuation">,</span> signedString<span class="token punctuation">]</span><span class="token punctuation">;</span>
        
        <span class="token comment">// NOTE: 调用支付结果开始支付</span>
        <span class="token punctuation">[</span><span class="token punctuation">[</span>AlipaySDK defaultService<span class="token punctuation">]</span> payOrder<span class="token punctuation">:</span>orderString fromScheme<span class="token punctuation">:</span>appScheme callback<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">(</span>NSDictionary <span class="token operator">*</span>resultDic<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">NSLog</span><span class="token punctuation">(</span>@<span class="token string">"reslut = %@"</span><span class="token punctuation">,</span>resultDic<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// TODO: 业务逻辑</span>
    
        <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
</div><div class="article-navigation"><span class="prev">Previous: <a href="Android.html">Android</a></span><span class="next">Next: <a href="PurchaseRestore.html">Purchase Restore</a></span></div><div class="article-foot"></div></div></div></div></div></div><script src="asset/reader.js"></script><script src="asset/plugins/api/reader/index.js"></script><script src="asset/plugins/youku/reader/index.js"></script><script src="asset/plugins/highlight/reader/index.js"></script><script src="asset/plugins/cloud-image/reader/index.js"></script><script src="asset/plugins/theme-default/reader/index.js"></script><script src="asset/plugins/search/reader/index.js"></script><script type="application/payload+json">{"config":{"plugins":["api","highlight","youku","cloud-image","search"],"pluginsConfig":{"theme-default":{"auto_open":true,"logo":[]},"api":{"default":{"url":"http:\/\/cashier.51mandou.com","contentType":"application\/json","headers":{"APP_ID":"20190307001","APP_SECRET":"123"},"security":[]}}},"cover":"cover.jpg","title":"AppInChinaPay","id":418460,"description":"AppInChinaServices.com"},"summary":[{"level":"1","title":"Introduction","ref":"Introduction.md","path":"Introduction.html","articles":[]},{"level":"2","title":"App Configuration","ref":"AppConfiguration.md","path":"AppConfiguration.html","articles":[]},{"level":"3","title":"SDK Installation","ref":"SDKInstallation.md","path":"SDKInstallation.html","articles":[{"level":"3.1","title":"Android SDK","ref":"AndroidSdk.md","path":"AndroidSdk.html","articles":[]},{"level":"3.2","title":"iOS SDK","ref":"iOSSdk.md","path":"iOSSdk.html","articles":[]}]},{"level":"4","title":"API","ref":"API.md","path":"API.html","articles":[{"level":"4.1","title":"API Authentication","ref":"APIAuthentication.md","path":"APIAuthentication.html","articles":[]},{"level":"4.2","title":"Pay Channel Init","ref":"PayToolsInit.md","path":"PayToolsInit.html","articles":[]},{"level":"4.3","title":"Create Order","ref":"Order.md","path":"Order.html","articles":[]},{"level":"4.4","title":"Query Order","ref":"QueryOrder.md","path":"QueryOrder.html","articles":[]},{"level":"4.5","title":"Query Order List","ref":"QueryOrderList.md","path":"QueryOrderList.html","articles":[]}]},{"level":"5","title":"Initiate Payment","ref":"InitiatePayment.md","path":"InitiatePayment.html","articles":[{"level":"5.1","title":"How to Fire a Pay","ref":"HowtoFireaPay.md","path":"HowtoFireaPay.html","articles":[]},{"level":"5.2","title":"Android","ref":"Android.md","path":"Android.html","articles":[]},{"level":"5.3","title":"iOS","ref":"iOS.md","path":"iOS.html","articles":[]}]},{"level":"6","title":"Purchase Restore","ref":"PurchaseRestore.md","path":"PurchaseRestore.html","articles":[{"level":"6.1","title":"Basic Principles","ref":"BasicPrinciples.md","path":"BasicPrinciples.html","articles":[]},{"level":"6.2","title":"Authentication","ref":"Authentication.md","path":"Authentication.html","articles":[]},{"level":"6.3","title":"Sms Code","ref":"SmsCode.md","path":"SmsCode.html","articles":[]},{"level":"6.4","title":"Logon Status Check","ref":"LogonStatusCheck.md","path":"LogonStatusCheck.html","articles":[]},{"level":"6.5","title":"Typical Scenarios","ref":"TypicalScenarios.md","path":"TypicalScenarios.html","articles":[]}]},{"level":"7","title":"Help","ref":"Help.md","path":"Help.html","articles":[{"level":"7.1","title":"Video","ref":"Video.md","path":"Video.html","articles":[]},{"level":"7.2","title":"Frequently Asked Questions","ref":"faq.md","path":"faq.html","articles":[]},{"level":"7.3","title":"Update Notes","ref":"UpdateNotes.md","path":"UpdateNotes.html","articles":[]}]}],"article":{"path":"iOS.html","ref":"iOS.md","title":"iOS","content":":-: **iOS**\n\n# 1.iOS for Wechat\nTODO:\n\n*****\n# 2. iOS for Alipay\n\n\n\n### 2.1. init Alipay parameter\r\n\n~~~ \nNSString *appID = @\" 129999000000\";\n\n~~~\n\n### 2.2. init api parameter\r\n~~~\n\n\/\/ order amount\nNSNumber *amountStr  =[NSNumber numberWithFloat:99.01] ;\n\n\/\/ your business NO.\nNSString  *bizNoStr = @\"biz20190001\" ;\n\n\/\/ your goods title\nNSString *titleStr = @\"test goods title \";\n\n\/\/ pay channel API\nstatic NSString  *BASE_URL =  \"http:\/\/cashier.51mandou.com\";\nstatic NSString *GET_PAY_TOOLS = BASE_URL + \"\/payTools.json\" ;\n\n\/\/ create Order API\nstatic NSString  *CREATE_ORDER  =  BASE_URL+\"\/order.json\";\n\n\/\/ your app_id \nfinal NSString APP_ID = \"20190307001\";\n\n\/\/  Api secret\nfinal NSString APP_SECRET = \"123\";\n\n~~~\n\r\n### 2.3. Get the pay channel by `Pay Channel` Api\r\n\nImport AFHTTPS package at file header\n\n~~~\n\nAFHTTPSessionManager *manger = [AFHTTPSessionManager manager];\nAFHTTPRequestSerializer *requestSerializer =  [AFJSONRequestSerializer serializer];\n\nNSDictionary *headerFieldValueDictionary = @{@\"version\":@\"1.0\"};\nif (headerFieldValueDictionary != nil) {\n    for (NSString *httpHeaderField in headerFieldValueDictionary.allKeys) {\n        NSString *value = headerFieldValueDictionary[httpHeaderField];\n        [requestSerializer setValue:value forHTTPHeaderField:httpHeaderField];\n    }\n}\nmanger.requestSerializer = requestSerializer;\n[manger GET:@\"url\" parameters:nil  progress:nil success:^(NSURLSessionDataTask * _Nonnull task, id  _Nullable responseObject) {\n       \n   } failure:^(NSURLSessionDataTask * _Nullable task, NSError * _Nonnull error) {\n       \n}];\n~~~\n\n\r\nrequest the api\r\n\r\nget the response\r\n\r\n### 2.4. Create your order by `Create Order` Api\r\n\r\nrequest the api\r\n\r\nget the response\r\n\r\n### 2.5 . Request Alipay to pay your order\r\n\r\n### 2.6. Query your order list\n\n\n2.1 iOS Object-c for alipay\n\n\n\n~~~\n\/\/\n\/\/ 选中商品调用支付宝极简支付\n\/\/\n- (void)doAPPay\n{\n    \/\/ 重要说明\n    \/\/ 这里只是为了方便直接向商户展示支付宝的整个支付流程；所以Demo中加签过程直接放在客户端完成；\n    \/\/ 真实App里，privateKey等数据严禁放在客户端，加签过程务必要放在服务端完成；\n    \/\/ 防止商户私密数据泄露，造成不必要的资金损失，及面临各种安全风险；\n    \/*============================================================================*\/\n    \/*=======================需要填写商户app申请的===================================*\/\n    \/*============================================================================*\/\n    NSString *appID = @\"\";\n    \n    \/\/ 如下私钥，rsa2PrivateKey 或者 rsaPrivateKey 只需要填入一个\n    \/\/ 如果商户两个都设置了，优先使用 rsa2PrivateKey\n    \/\/ rsa2PrivateKey 可以保证商户交易在更加安全的环境下进行，建议使用 rsa2PrivateKey\n    \/\/ 获取 rsa2PrivateKey，建议使用支付宝提供的公私钥生成工具生成，\n    \/\/ 工具地址：https:\/\/doc.open.alipay.com\/docs\/doc.htm?treeId=291&articleId=106097&docType=1\n\n    NSString *rsa2PrivateKey = @\"\";\n    NSString *rsaPrivateKey = @\"\";\n\n    \/*============================================================================*\/\n    \/*============================================================================*\/\n    \/*============================================================================*\/\n    \n    \/\/partner和seller获取失败,提示\n\n    if ([appID length] == 0 ||\n        ([rsa2PrivateKey length] == 0 && [rsaPrivateKey length] == 0))\n    {\n        UIAlertController *alert = [UIAlertController alertControllerWithTitle:@\"提示\"\n                                                                       message:@\"缺少appId或者私钥,请检查参数设置\"\n                                                                preferredStyle:UIAlertControllerStyleAlert];\n        UIAlertAction *action = [UIAlertAction actionWithTitle:@\"知道了\"\n                                                         style:UIAlertActionStyleDefault\n                                                       handler:^(UIAlertAction *action){\n                                                           \n                                                       }];\n        [alert addAction:action];\n        [self presentViewController:alert animated:YES completion:^{ }];\n        return;\n    }\n    \n    \/*\n     *生成订单信息及签名\n     *\/\n    \/\/将商品信息赋予AlixPayOrder的成员变量\n    APOrderInfo* order = [APOrderInfo new];\n    \n    \/\/ NOTE: app_id设置\n    order.app_id = appID;\n    \n    \/\/ NOTE: 支付接口名称\n    order.method = @\"alipay.trade.app.pay\";\n    \n    \/\/ NOTE: 参数编码格式\n    order.charset = @\"utf-8\";\n    \n    \/\/ NOTE: 当前时间点\n    NSDateFormatter* formatter = [NSDateFormatter new];\n    [formatter setDateFormat:@\"yyyy-MM-dd HH:mm:ss\"];\n    order.timestamp = [formatter stringFromDate:[NSDate date]];\n    \n    \/\/ NOTE: 支付版本\n    order.version = @\"1.0\";\n    \n    \/\/ NOTE: sign_type 根据商户设置的私钥来决定\n    order.sign_type = (rsa2PrivateKey.length > 1)?@\"RSA2\":@\"RSA\";\n    \n    \/\/ NOTE: 商品数据\n    order.biz_content = [APBizContent new];\n    order.biz_content.body = @\"我是测试数据\";\n    order.biz_content.subject = @\"1\";\n    order.biz_content.out_trade_no = [self generateTradeNO]; \/\/订单ID（由商家自行制定）\n    order.biz_content.timeout_express = @\"30m\"; \/\/超时时间设置\n    order.biz_content.total_amount = [NSString stringWithFormat:@\"%.2f\", 0.01]; \/\/商品价格\n    \n    \/\/将商品信息拼接成字符串\n    NSString *orderInfo = [order orderInfoEncoded:NO];\n    NSString *orderInfoEncoded = [order orderInfoEncoded:YES];\n    NSLog(@\"orderSpec = %@\",orderInfo);\n    \n    \/\/ NOTE: 获取私钥并将商户信息签名，外部商户的加签过程请务必放在服务端，防止公私钥数据泄露；\n    \/\/       需要遵循RSA签名规范，并将签名字符串base64编码和UrlEncode\n    NSString *signedString = nil;\n    APRSASigner* signer = [[APRSASigner alloc] initWithPrivateKey:((rsa2PrivateKey.length > 1)?rsa2PrivateKey:rsaPrivateKey)];\n\n    if ((rsa2PrivateKey.length > 1)) {\n        signedString = [signer signString:orderInfo withRSA2:YES];\n    } else {\n        signedString = [signer signString:orderInfo withRSA2:NO];\n    }\n    \n    \/\/ NOTE: 如果加签成功，则继续执行支付\n    if (signedString != nil) {\n        \/\/应用注册scheme,在AliSDKDemo-Info.plist定义URL types\n        NSString *appScheme = @\"alisdkdemo\";\n        \n        \/\/ NOTE: 将签名成功字符串格式化为订单字符串,请严格按照该格式\n        NSString *orderString = [NSString stringWithFormat:@\"%@&sign=%@\",\n                                 orderInfoEncoded, signedString];\n        \n        \/\/ NOTE: 调用支付结果开始支付\n        [[AlipaySDK defaultService] payOrder:orderString fromScheme:appScheme callback:^(NSDictionary *resultDic) {\n            NSLog(@\"reslut = %@\",resultDic);\n            \/\/ TODO: 业务逻辑\n    \n        }];\n    }\n}\n\n~~~"},"options":{"base":".\/","environment":"reader"},"style":""}</script><script type="text/javascript">kancloud.bootstrap('app');</script></body></html>